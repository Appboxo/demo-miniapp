<!doctype html>
<html class="no-js" lang="">

<head>
  <meta charset="utf-8">
  <title>AppBoxo Connect API demo</title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css?family=Noto+Sans&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/main.css">

  <meta name="theme-color" content="#fafafa">
</head>

<body>
  <!--[if IE]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->

  <section class="pane intro">
    <h1>Appboxo Connect API demo</h1>
    <p>This demo shows Appboxo Connect API capabilities to pass login credentials from host app to miniapp.</p>
    <p>Tap on account details button to login in the miniapp with credentials from Appboxo demo app.</p>
    <button class="button">Account details</button>
  </section>

  <section class="pane account">
    <h1>Account details</h1>
    <div class="account__email">
      Email: <span>Unknown</span>
    </div>
    <button class="button login">Login</button>
    <button class="button button-light logout">Logout</button>
  </section>

  <section class="confirm">
    <div class="confirm-modal">
      <div class="confirm-modal__close">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 30 30">
          <path d="M15,3C8.373,3,3,8.373,3,15c0,6.627,5.373,12,12,12s12-5.373,12-12C27,8.373,21.627,3,15,3z M19.707,18.293 c0.391,0.391,0.391,1.023,0,1.414C19.512,19.902,19.256,20,19,20s-0.512-0.098-0.707-0.293L15,16.414l-3.293,3.293 C11.512,19.902,11.256,20,11,20s-0.512-0.098-0.707-0.293c-0.391-0.391-0.391-1.023,0-1.414L13.586,15l-3.293-3.293 c-0.391-0.391-0.391-1.023,0-1.414s1.023-0.391,1.414,0L15,13.586l3.293-3.293c0.391-0.391,1.023-0.391,1.414,0s0.391,1.023,0,1.414 L16.414,15L19.707,18.293z"></path>
        </svg>
      </div>
      <div class="confirm-modal__icon">
        <svg width="50" height="50" viewBox="0 0 50 50" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M35.4166 43.75V39.5833C35.4166 34.981 31.6857 31.25 27.0833 31.25H10.4166C5.81427 31.25 2.08331 34.981 2.08331 39.5833V43.75" stroke="black" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M18.75 22.9167C23.3524 22.9167 27.0834 19.1857 27.0834 14.5833C27.0834 9.98096 23.3524 6.25 18.75 6.25C14.1476 6.25 10.4167 9.98096 10.4167 14.5833C10.4167 19.1857 14.1476 22.9167 18.75 22.9167Z" stroke="black" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M47.9167 43.7499V39.5833C47.9139 35.7856 45.3438 32.4702 41.6667 31.5208" stroke="black" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M33.3333 6.52075C37.0206 7.46486 39.5997 10.7874 39.5997 14.5937C39.5997 18.3999 37.0206 21.7225 33.3333 22.6666" stroke="black" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      <h3>This service is requesting access to your account</h3>
      <p>The service will be able to see the email address linked to your account</p>
      <button class="button">Allow</button>
    </div>
  </section>

  <div class="preloader">
    <div class="preloader__spinner">
      <div class="spinner"></div>
    </div>
  </div>

  <div class="pane success">
    <div class="center">
      <div>
        <svg width="135" height="94" viewBox="0 0 135 94" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M133 2L42.9375 92L2 51.0909" stroke="black" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
  
        <h3>Successfully authorised</h3>
      </div>
    </div>
    <button class="button">Continue</button>
  </div>

  <div class="pane error">
    <div class="center">
      <div>
        <svg width="138" height="138" viewBox="0 0 138 138" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M69 126.5C100.756 126.5 126.5 100.756 126.5 69C126.5 37.2436 100.756 11.5 69 11.5C37.2436 11.5 11.5 37.2436 11.5 69C11.5 100.756 37.2436 126.5 69 126.5Z" stroke="black" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M69 46V69" stroke="black" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
          <circle cx="69" cy="92" r="5.75" fill="black"/>
        </svg>
        <h3>Unsuccessful authorisation</h3>
      </div>
    </div>
    <button class="button">Try again</button>
  </div>
    


  <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
  <script>
    // Account details
    $('.intro button').click(function() {
      $('.intro').hide()
      $('.account').show()
    })

    // Login
    $('.account .login').click(function() {
      $('.confirm').show()
    })

    // Continue button
    $('.success .button').click(function() {
      $('.success').hide()
    })

    // Try again button
    $('.error .button').click(function() {
      $('.error').hide()

      $('.preloader').show()

      // Call backend
      connect()
    })

    // Confirm
    $('.confirm button').click(function() {
      $('.confirm').hide()
      $('.preloader').show()

      // Call backend
      connect()
    })

    // Confirm close icon
    $('.confirm-modal__close').click(function() {
      $('.confirm').hide()
    })

    // Logout
    $('.account .logout').click(function() {
      
    })

    function connect() {
      var token = localStorage.getItem('token')
      login_if_valid_token(token)
      var app_id = localStorage.getItem('app_id')
      var client_id = localStorage.getItem('client_id')
      var payload = localStorage.getItem('payload')

      $.ajax('https://dashboard.appboxo.com/partner/login/', {
        method: 'post',
        data: {
          client_id: client_id,
          app_id: app_id,
          payload: payload,
        },
        success: function (data) {
          if(data.status === 'error'){
            console.log('Error: ', data)
            $('.error').show()
          } else {
            console.log('Success:', data)
            $('.success').show()
          }

          login_if_valid_token(data.token)

          // Toggle login/logout button
          $('.account .login').hide()
          $('.account .logout').show()
        },
        error: function (data) {
          console.log('Error: ', data)
          $('.error').show()
        },
        complete: function () {
          // Hide preloader
          $('.preloader').hide()
        }
      })
    }




      function login_if_valid_token(token) {
          if (token && token !== '') {
              $.get(document.location.origin + '?auth_token=' + token, function (data, status) {
                  if (status === 'success') {
                      document.location = document.location.origin + '?auth_token=' + token
                      try {
                          AppboxoJs.saveToken(token)
                      } catch (e) {
                          $('#error').text(e);
                      }
                      try {
                            webkit.messageHandlers.saveToken.postMessage(
                              {
                                  token: token
                              });
                      } catch(err) {
                          $('#error').text(err);
                      }
                  }
              }).fail(function (e) {
                  console.log(e)
                  $('#error').text(e.responseText);
              })
          }
      }
  
      function initMiniApp(app_id, client_id, payload, token = '') {
          login_if_valid_token(token)
          // $('#app_id').text(app_id);
          // $('#client_id').text(client_id);
          // $('#payload').text(payload);
          // $('#token').text(token);
  
          localStorage.setItem('app_id', app_id)
          localStorage.setItem('client_id', client_id)
          localStorage.setItem('token', token)
          localStorage.setItem('payload', payload)
      }

      // $('#localStorage').text(Object.entries(localStorage))
  </script>
</body>

</html>
